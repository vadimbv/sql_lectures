Предположим, у вас есть таблица sales, которая содержит информацию о продажах различных товаров в разных магазинах по разным годам. Задача состоит в том, чтобы получить общую сумму продаж по годам, по магазинам и в общем.

```sql
SELECT
    region,
    category,
    SUM(sales) AS total_sales
FROM
    orders
GROUP BY
    ROLLUP(region, category);
```

В этом запросе:

    TO_CHAR(sale_date, 'YYYY') AS sale_year используется для извлечения года из даты продажи.
    store_id используется для группировки по магазинам.
    SUM(sale_amount) вычисляет общую сумму продаж.
	
	

Предположим, у вас есть таблица orders, содержащая информацию о заказах в разных регионах по различным категориям товаров. Задача состоит в том, чтобы получить суммарные продажи по регионам и категориям товаров, а также общие суммы продаж по регионам с использованием GROUP BY ROLLUP.

SELECT
    region,
    category,
    SUM(sales) AS total_sales
FROM
    orders
GROUP BY
    ROLLUP(region, category);

В этом запросе:

    region и category - это столбцы, по которым мы хотим выполнить группировку.
    SUM(sales) вычисляет сумму продаж для каждой комбинации region и category.

Инструкция GROUP BY ROLLUP добавляет строки для каждого уровня группировки, начиная с наиболее детализированного и заканчивая общими итогами. В результате получается иерархия суммарных значений, которая может быть полезна для анализа данных и создания отчетов.


Инструкция `GROUP BY CUBE` в SQL используется для создания многомерных сводок данных путем группировки по всем возможным комбинациям указанных столбцов. Это позволяет вычислять агрегатные значения, такие как сумма, среднее, максимальное и минимальное значение для различных комбинаций групп.

### Пример задачи

Предположим, у нас есть таблица продаж `sales` с такими столбцами:
- `region` — регион продаж
- `product` — продукт
- `sales_amount` — сумма продаж

Наша задача — вычислить общую сумму продаж для каждой комбинации региона и продукта, а также для всех регионов и всех продуктов.

### Пример данных

```sql
CREATE TABLE sales (
    region VARCHAR(50),
    product VARCHAR(50),
    sales_amount DECIMAL(10, 2)
);

INSERT INTO sales (region, product, sales_amount) VALUES
('North', 'Apples', 100.00),
('North', 'Oranges', 150.00),
('South', 'Apples', 200.00),
('South', 'Oranges', 250.00),
('East', 'Apples', 300.00),
('East', 'Oranges', 350.00);
```

### Запрос с использованием `GROUP BY CUBE`

```sql
SELECT
    region,
    product,
    SUM(sales_amount) AS total_sales
FROM
    sales
GROUP BY
    CUBE (region, product);
```

### Ожидаемый результат

| region | product | total_sales |
|--------|---------|-------------|
| North  | Apples  | 100.00      |
| North  | Oranges | 150.00      |
| North  | NULL    | 250.00      |
| South  | Apples  | 200.00      |
| South  | Oranges | 250.00      |
| South  | NULL    | 450.00      |
| East   | Apples  | 300.00      |
| East   | Oranges | 350.00      |
| East   | NULL    | 650.00      |
| NULL   | Apples  | 600.00      |
| NULL   | Oranges | 750.00      |
| NULL   | NULL    | 1350.00     |

### Объяснение результата

- Строки с конкретными значениями в обоих столбцах (`region` и `product`) представляют собой суммы продаж для каждой конкретной комбинации региона и продукта.
- Строки с `NULL` в столбце `product` представляют собой суммы продаж для каждого региона по всем продуктам.
- Строки с `NULL` в столбце `region` представляют собой суммы продаж для каждого продукта по всем регионам.
- Строка с `NULL` в обоих столбцах представляет собой общую сумму продаж по всем регионам и продуктам.

### Применение

Этот запрос полезен для создания сводных отчетов и анализа данных по различным измерениям, что позволяет выявлять тенденции и паттерны в продажах по регионам и продуктам.


`GROUP BY CUBE` и `GROUPING SETS` — оба оператора используются для создания многомерных сводок данных, но они различаются в плане гибкости и способа создания группировок. Давайте рассмотрим их различия на примере.

### `GROUP BY CUBE`

`GROUP BY CUBE` генерирует все возможные комбинации группировок для указанных столбцов. Это удобно, когда нужно получить все комбинации агрегированных данных.

Пример:

```sql
SELECT
    region,
    product,
    SUM(sales_amount) AS total_sales
FROM
    sales
GROUP BY
    CUBE (region, product);
```

Этот запрос создаст все возможные комбинации группировок для `region` и `product`.

### `GROUPING SETS`

`GROUPING SETS` предоставляет более гибкий способ определения конкретных группировок, которые вы хотите получить. Он позволяет явно указать, какие наборы группировок должны быть включены в результат.

Пример:

```sql
SELECT
    region,
    product,
    SUM(sales_amount) AS total_sales
FROM
    sales
GROUP BY
    GROUPING SETS (
        (region, product),
        (region),
        (product),
        ()
    );
```

Этот запрос создаст только указанные группировки:

1. `(region, product)` — сумма продаж по комбинации региона и продукта.
2. `(region)` — сумма продаж по каждому региону.
3. `(product)` — сумма продаж по каждому продукту.
4. `()` — общая сумма продаж.

### Пример данных и результаты

```sql
CREATE TABLE sales (
    region VARCHAR(50),
    product VARCHAR(50),
    sales_amount DECIMAL(10, 2)
);

INSERT INTO sales (region, product, sales_amount) VALUES
('North', 'Apples', 100.00),
('North', 'Oranges', 150.00),
('South', 'Apples', 200.00),
('South', 'Oranges', 250.00),
('East', 'Apples', 300.00),
('East', 'Oranges', 350.00);
```

### `GROUP BY CUBE` Результат

| region | product | total_sales |
|--------|---------|-------------|
| North  | Apples  | 100.00      |
| North  | Oranges | 150.00      |
| North  | NULL    | 250.00      |
| South  | Apples  | 200.00      |
| South  | Oranges | 250.00      |
| South  | NULL    | 450.00      |
| East   | Apples  | 300.00      |
| East   | Oranges | 350.00      |
| East   | NULL    | 650.00      |
| NULL   | Apples  | 600.00      |
| NULL   | Oranges | 750.00      |
| NULL   | NULL    | 1350.00     |

### `GROUPING SETS` Результат

| region | product | total_sales |
|--------|---------|-------------|
| North  | Apples  | 100.00      |
| North  | Oranges | 150.00      |
| North  | NULL    | 250.00      |
| South  | Apples  | 200.00      |
| South  | Oranges | 250.00      |
| South  | NULL    | 450.00      |
| East   | Apples  | 300.00      |
| East   | Oranges | 350.00      |
| East   | NULL    | 650.00      |
| NULL   | Apples  | 600.00      |
| NULL   | Oranges | 750.00      |
| NULL   | NULL    | 1350.00     |

### Заключение

- **`GROUP BY CUBE`** генерирует все возможные комбинации группировок для указанных столбцов. Это удобно, когда требуется полный набор агрегированных данных для всех комбинаций.
- **`GROUPING SETS`** предоставляет более гибкий и точный способ указания конкретных наборов группировок, которые нужно включить в результат. Это позволяет оптимизировать запрос и получить только те группировки, которые действительно необходимы.
